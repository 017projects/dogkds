<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pedido - funcionário 2</title>
  <link rel="stylesheet" href="funcionario.css">
</head>
<body>
  <div class="container">
    <h1>02</h1>

    <div class="pedido"></div> <!-- Aqui exibe o pedido -->
    
    <!-- Botão para finalizar o pedido -->
    <button id="finalizarPedido">Finalizar Pedido</button>
  </div>

  <button id="logoutButton" class="logout">Logout</button>

  <script type="module">
    // Importa e inicializa o Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    // Configuração do Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyAu1yGt5pSj8Sm6L1DSZCe3p92hOoPH8Qw",
        authDomain: "newkds-54a3d.firebaseapp.com",
        projectId: "newkds-54a3d",
        storageBucket: "newkds-54a3d.firebasestorage.app",
        messagingSenderId: "87279752281",
        appId: "1:87279752281:web:80ed11fbc19c4c872b4d48"
    };
    
    // Inicializa o Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // Seleciona a div onde o pedido será exibido
    const pedidoContainer = document.querySelector('.pedido');
    
    // Função para buscar o ID do pedido no Firestore
    async function buscarPedidoId() {
    console.log("Iniciando busca de pedidos para o funcionário 2...");

    try {
        // Buscar o documento do funcionário na coleção "funcionarios"
        const funcionarioRef = doc(db, "funcionarios", "funcionario2");
        const funcionarioSnap = await getDoc(funcionarioRef);

        if (!funcionarioSnap.exists()) {
            console.error("Funcionário não encontrado no Firestore.");
            return;
        }

        const funcionarioData = funcionarioSnap.data();
        const orderId = funcionarioData.produtoId; // Obtendo o ID do pedido diretamente

        if (!orderId) {
            console.error("Nenhum ID de pedido encontrado para o funcionário.");
            setTimeout(() => {
              window.location.reload();
            }, 5000);
            return;
        }

        console.log("ID do pedido encontrado:", orderId);

        // Chamar a API para obter os detalhes do pedido
        const detalhesPedido = await buscarDetalhesDoPedido(orderId);
        if (detalhesPedido) {
            exibirDetalhesDoPedido(detalhesPedido); // Exibe os detalhes do pedido
            // Configura o botão para finalizar o pedido
            const finalizarButton = document.getElementById('finalizarPedido');
            finalizarButton.addEventListener('click', () => finalizarPedido(orderId));  // Configura a ação ao clicar no botão
        } else {
            console.error("Erro ao obter os detalhes do pedido.");
        }

    } catch (error) {
        console.error("Erro ao buscar pedido:", error);
    }
}

async function updateFuncionario() {
  const funcionarioRef = doc(db, "funcionarios", "funcionario2");
  const funcionarioSnap = await getDoc(funcionarioRef);
  const funcionarioData = funcionarioSnap.data()
  const funcionarioLivre = funcionarioData.funcionarioLivre;

  await updateDoc(funcionarioRef, {
    funcionarioLivre: true,
    produtoId: '',
    livreDesde: new Date().getDate() + '/' + (new Date().getMonth()+1) + '/' + new Date().getFullYear() + ' - ' + new Date().getHours() + ':' + new Date().getMinutes() + ':' + new Date().getSeconds(),
  })
}

    // Função para buscar os detalhes do pedido através da API
async function buscarDetalhesDoPedido(orderId) {
    const token = 'eyJhbGciOiJIUzI1NiJ9.eyJpZHBhcnRuZXIiOiI2N2FlYWFkMGE5YTBhNTAwMTk4ZGU0NDMiLCJpZHBhZ2UiOiI2NTRlMmEyNDY2ZjBkYzAwMTkzY2M3NjgifQ.Zw7tLxJfAakrZaweDaly1iWjXWYs1wZ73nxKW7TFO9c'; // Token da API
    const url = `https://api-parceiros.anota.ai/partnerauth/ping/get/${orderId}`;
    
    try {
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Authorization': `${token}`,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            console.log("Detalhes do pedido recebidos da API:", data);  // Adicionando o log aqui
            return data;  // Retorna os detalhes do pedido
        } else {
            console.error("Erro na API:", response.status, response.statusText);
            return null;
        }
    } catch (error) {
        console.error("Erro ao chamar a API:", error);
        return null;
    }
}

// Função para enviar o pedido como "pronto" para a API
async function finalizarPedido(orderId) {

    const token = 'eyJhbGciOiJIUzI1NiJ9.eyJpZHBhcnRuZXIiOiI2N2FlYWFkMGE5YTBhNTAwMTk4ZGU0NDMiLCJpZHBhZ2UiOiI2NTRlMmEyNDY2ZjBkYzAwMTkzY2M3NjgifQ.Zw7tLxJfAakrZaweDaly1iWjXWYs1wZ73nxKW7TFO9c'; // Token da API
    const url = `https://api-parceiros.anota.ai/partnerauth/order/ready/${orderId}`;

    const pedidosNovosRef = collection(db, "pedidosNovos");

    try {
        // Cria a consulta para buscar o documento com o campo 'id' igual ao valor fornecido
        const q = query(pedidosNovosRef, where("id", "==", orderId));

        // Obtém os documentos que correspondem à consulta
        const querySnapshot = await getDocs(q);

        // Verifica se algum documento foi encontrado
        if (querySnapshot.empty) {
            console.log("Nenhum documento encontrado com o id fornecido.");
            return;
        }

        // Se um documento for encontrado, exclui o primeiro documento encontrado
        querySnapshot.forEach(async (docSnap) => {
            const docRef = doc(db, "pedidosNovos", docSnap.id);
            await deleteDoc(docRef);  // Exclui o documento
            console.log(`Documento com id ${orderId} excluído com sucesso!`);
        });
    } catch (error) {
        console.error("Erro ao excluir o documento:", error);
    }


    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Authorization': `${token}`,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({})  // Corpo da requisição, se necessário. Caso não tenha nada a enviar, pode ser vazio
        });

        if (response.ok) {
            const data = await response.json();
            console.log("Pedido finalizado:", data);  // Log da resposta da API
        } else {
            console.error("Erro ao finalizar o pedido:", response.status, response.statusText);
            alert("Erro ao finalizar o pedido. Tente novamente.");
        }
    } catch (error) {
        console.error("Erro ao chamar a API:", error);
        alert("Erro ao finalizar o pedido. Tente novamente.");
    }

    updateFuncionario();

    setTimeout(() => {
      window.location.reload()
    }, 2000);
}


    // Função para exibir os detalhes do pedido na interface
// Função para exibir os detalhes do pedido na interface
async function exibirDetalhesDoPedido(detalhesPedido) {
    console.log("Estrutura dos dados do pedido:", detalhesPedido);  // Logando os dados para análise

    // Verifica se 'info' e 'info.items' existem e são um array
    if (!detalhesPedido || !detalhesPedido.info || !Array.isArray(detalhesPedido.info.items)) {
        pedidoContainer.innerHTML = "<p>Erro ao exibir detalhes do pedido. Itens não encontrados.</p>";
        return;
    }

    const { shortReference, items, observation } = detalhesPedido.info;

    // Lista de palavras-chave para identificar refrigerantes
    const itensOcultos = ["refrigerante", "coca-cola", "guaraná", "fanta", "sprite", "guarana", "itubaina", "h2o", 'sukita', 'schweppes', 'agua', 'chocolate', 'honey', 'coca'];

    // Filtra os itens que não devem ser exibidos
    const itensFiltrados = items.filter(item => 
        !itensOcultos.some(nome => item.name.toLowerCase().includes(nome))
    );

    // Atualiza a div com os detalhes do pedido
     pedidoContainer.innerHTML = `
    <p><strong>Pedido #${shortReference}</strong></p>
    <p><strong>Itens:</strong></p>
    <ul>
        ${itensFiltrados.map((item, index) => `
            ${Array.from({ length: item.quantity }).map((_, i) => `
                <li class="item">
                    <span>1x ${item.name}</span>
                    <input type="checkbox" id="item-${index}-${i}" class="item-checkbox">
                    
                    ${Array.isArray(item.subItems) && item.subItems.length > 0 ? `
                        <ul class="subitem-list">
                            ${item.subItems.map(subItem => `
                                ${Array.from({ length: subItem.quantity }).map(() => `
                                    <li class="subitem">
                                        1x ${subItem.name}
                                    </li>
                                `).join('')}
                            `).join('')}
                        </ul>
                    ` : ''}

                    ${item.observation ? `<p class="item-observacao"><strong>Observação:</strong> ${item.observation}</p>` : ''}
                </li>
                <hr>
            `).join('')}
        `).join('')}
    </ul>
    ${observation ? `<p class="observacao"><strong>Observação Geral:</strong> ${observation}</p>` : ''}`;
}



    // Chama a função para buscar e exibir o pedido assim que a página carregar
    buscarPedidoId();

    document.getElementById('logoutButton').addEventListener('click', async function(){
  const funcionarioRef = doc(db, "funcionarios", "funcionario2");
  const funcionarioSnap = await getDoc(funcionarioRef);
  const funcionarioData = funcionarioSnap.data()
  const funcionarioLivre = funcionarioData.funcionarioLivre;

  await updateDoc(funcionarioRef, {
    funcionarioLivre: false,
    aberto: false,
  })

  history.back();
})
  </script>
</body>
</html>
